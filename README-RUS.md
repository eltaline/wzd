<img src="/images/logo.png" alt="wZD Logo"/>

wZD это сервер написанный на языке Go, использующий <a href=https://github.com/eltaline/bolt>модифицированную</a> версию BoltDB баз,
как бекенд для сохранения и раздачи любого количества маленьких и больших файлов, NoSQL ключей/значений,
в компактном виде внутри микро Bolt баз данных(архивов) с распределением файлов/значений в BoltDB базах в зависимости от количества директорий/поддиректорий и общей структуры директорий. При помощи wZD можно навсегда решить проблему большого количества файлов на любой POSIX совместимой файловой системе, в том числе кластерной. Внешне он работает как обычный WebDAV сервер.

...И миллиарды файлов больше не будут проблемой.

<img src="/images/wzd-scheme.png" alt="wZD Scheme"/>

Текущая стабильная версия: 1.0.0
========

Возможности
========

- Многопоточность.
- Мультисерверность для отказоустойчивости и балансировки нагрузки.
- Максимальная прозрачность для пользователя или разработчика.
- Поддерживаемые HTTP методы: GET/HEAD/PUT/DELETE.
- Управление поведением при чтении и записи через клиентские заголовки.
- Поддержка гибко настраиваемых виртуальных хостов.
- Линейное масштабирование чтения и записи при использовании кластерных файловых систем.
- Эффективные методы чтения и записи данных.
- Поддержка CRC целостности данных при записи/чтении.
- Поддержка заголовков Range/Accept-Ranges, If-None-Match/If-Modifed-Since.
- Позволяет хранить и раздавать в 10000 раз больше файлов, чем есть inodes на любой Posix совместимой файловой системе. Зависит от планирования структуры директорий.
- Поддержка добавления/обновления/удаления файлов/значение и отложенной компакции Bolt архивов.
- Позволяет использовать сервер как NoSQL базу с легким шардингом на базе структуры директорий.
- Bolt архивы поддерживают выборочное чтение определенного количества байт из значения.
- Легкий шардинг данных по тысячам/миллионам Bolt архивам на базе структуры директорий.
- Поддержка смешанного режима. Большие файлы могут сохраняться отдельно от Bolt архивов.
- Поддержка получения списка/количества ключей в директории, в том числе не уникальных.
- Полудинамические буферы для минимального потребления памяти и оптимальной настройки сетевой производительности.
- В дополнение предлагается многопоточный архиватор <a href=https://github.com/eltaline/wza>wZA</a> для миграции файлов без остановки сервиса.

Несовместимости
========

- Не поддерживается Multipart.
- Пока не поддерживается POST метод.
- Пока не поддерживается HTTPS протокол.
- Пока нет нативного протокола и драйверов для разных языков программирования.
- Пока нет возможности прозрачно примонтировать структуру как файловую систему через WebDAV/FUSE.
- Сервер не поддерживает рекурсивное удаление директорий в целях безопасности.
- Cервер не позволяет загружать файлы в корневую директорию виртуального хоста (касается только Bolt архивов).
- В директориях и поддиректориях виртуальных хостов не допускается чужих файлов с расширением .bolt
- Нельзя просто так взять и перенести диски с данными из Little Endian системы в Big Endian систему и наоборот.

Multipart не будет поддерживаться, так как требуется строгая запись конкретного количества данных,
чтобы не образовывались недозагруженные файлы и не возникали другие проблемы.

Используйте только бинарный протокол передачи данных для записи файлов/значений.

Требования
========

- **Использовать wZD сервер только за реверс прокси серверами типа nginx/haproxy.**
- Операционные системы: 64 Bit Linux.
- Архитектуры: x86_64 / остальные пока не проверялись. Поддерживаемый порядок байт Little/Big Endian.

Реальное применение
========

Наш кластер имеет порядка 250 000 000 маленьких картинок и 15 000 000 директорий на раздельных SATA дисках.
Используемая кластерная файловая система MooseFS. Она неплохо работает с таким количеством файлов,
но при этом ее Master серверы потребляют по 75 гигабайт оперативной памяти, и так как происходят частые дампы
большого количества метаданных, то это плохо сказывается на SSD дисках. Еще соответственно есть ограничение примерно
в 1 миллиард файлов в самой MooseFS при 1-ой реплике каждого файла.

В среднем у нас в разрозненной структуре директорий, где хранятся от 10 до 1000 файлов в большинстве директорий, после установки wZD и архивирования файлов в Bolt архивы, у нас получилось примерно в 200+ раз меньше файлов, около 10 000 000. При правильном планировании структуры директорий можно было бы добиться и меньшего количества файлов, но какая структура уже была, такая пока и осталась. Этим мы добились очень большой экономии inodes, низкого потребления памяти кластерной ФС, значительного ускорения работы самой MooseFS, и сокращения реально занимаемого места на кластерной ФС MooseFS. Дело в том, что MooseFS выделяет под каждый файл блок всегда размером 64KB, то есть если у вас файл имеет размер 3KB, то выделено все равно будет 64KB.

Многопоточный <a href=https://github.com/eltaline/wza>wZA</a> архиватор уже протестирован на реальных данных.

Наш кластер(10 серверов) это Origin сервер, установленный за CDN сетью и обслуживаемый всего 2-мя wZD серверами.

Смешанное применение
========

wZD разрабатывался как сервер для смешанного применения. Можно записывать не только обычные файлы, но даже прегенерированные html/json документы, и даже просто использовать как шардинговую NoSQL базу состояющую из большого количества маленьких BoltDB баз данных, а весь шардинг вести через структуру директорий и поддиректорий.

Тесты производительности
========

**Тестирование показывает разницу чтения/записи между работой с обычными файлами и Bolt архивами.
Параметры writeintegrity и readintegrity включены, то есть при записи/чтении файлов в Bolt архивах используется CRC.**

**Важно: время в тестах указано за полноценные GET/PUT запросы, в эти миллисекунды включены полная запись/чтение файлов HTTP клиентом.**

Тесты проводились на SSD дисках, так как на SATA дисках тесты получаются не очень объективными, не видно четкой разницы между работой с Bolt архивами и обычными файлами.

В тесте участвуют файлы 32KB, 256KB, 1024KB, 4096KB, 32768KB.

- GET 1000 файлов

<img src="/images/get-files.png"/>

- GET 1000 файлов из 1000 Bolt архивов.

<img src="/images/get-bolts.png"/>

- PUT 1000 файлов

<img src="/images/put-files.png"/>

- PUT 1000 файлов в 1000 Bolt архивов.

<img src="/images/put-bolts.png"/>

Как видно по графикам, разница практически не значительная.

Ниже предлагается более наглядный тест с файлами размером в 32 мегабайта. В этом случае запись в Bolt архивы становится более медленной, по сравнению с записью обычных файлов. Хотя это как считать, запись 32MB за 300ms в общем-то достаточно быстро.
Чтение таких файлов работает вполне быстро и если требуется хранить файлы больших размеров именно в Bolt архивах, и скорость записи не очень критична, тогда вполне допускается такое использование, но не рекомендуется.

- GET 32M 1000 файлов и файлов из Bolt архивов.

<img src="/images/get-32M.png"/>

- PUT 32M 1000 файлов и файлов в Bolt архивы.

<img src="/images/put-32M.png"/>

Документация
========

Установка
------------

**Если вы устанавливаете wZD из пакетов deb/rpm или из бинарников, то параметры upload/delete выключены по умолчанию в конфигурационном файле /etc/wzd/wzd.conf, в виртуальном хосте localhost, в целях безопасности.**

Установка пакетов/бинарников
------------

- <a href=https://github.com/eltaline/wzd/releases>Скачать</a>

```
systemctl enable wzd && systemctl start wzd
```

Установка docker образа
------------

**В Docker образе устанавливается nginx и wZD**

```bash
docker run -d --restart=always -e host=localhost -e root=/var/storage \
-v /var/storage:/var/storage --name wzd -p 80:80 eltaline/wzd
```

Более расширенный вариант:

```bash
docker run -d --restart=always -e host=localhost -e root=/var/storage \
-e upload=true -e delete=true -e compaction=true -e fmaxsize=1048576 \
-e writeintegrity=true -e readintegrity=true \
-e args=false -e getbolt=false -e getcount=true -e getkeys=true \
-e nonunique=false -e cctrl=2592000 -e delbolt=false -e deldir=false \
-v /var/storage:/var/storage --name wzd -p 80:80 eltaline/wzd
```

Все ENV параметры по умолчанию посмотреть тут: <a href=/Dockerfile>Dockerfile</a>

- Включите ротацию на хост системе для контейнеров:

Положите в /etc/logrotate.d/

```
/var/lib/docker/containers/*/*.log {
        rotate 7
        daily
        compress
        missingok
        delaycompress
        copytruncate
}
```

Настройка и использование wZD сервера
------------

В большинстве случаев достаточно воспользоваться конфигурационным файлом по умолчанию.
Полное описание всех параметров продукта доступно здесь: <a href="/OPTIONS-RUS.md">Опции</a>

Скачивание файла (приоритетно скачивается существующий обычный файл а не тот, что в Bolt архиве):

```bash
curl -o test.jpg http://localhost/test/test.jpg
```

Скачивание файла из Bolt архива (принудительно):

```bash
curl -o test.jpg -H "FromArchive: 1" http://localhost/test/test.jpg
```

Загрузка обычного файла в директорию:

```bash
curl -X PUT --data-binary @test.jpg http://localhost/test/test.jpg
```

Загрузка файла в Bolt архив (если не превышен серверный параметр fmaxsize)

```bash
curl -X PUT -H "Archive: 1" --data-binary @test.jpg http://localhost/test/test.jpg
```

Получение подсчета количества ключей в директории (если серверный параметр getcount = true)

```bash
curl -H "KeysCount: 1" http://localhost/test/test.jpg
```

Получение списка уникальных имен файлов/ключей в директории (если серверный параметр getkeys = true)

```bash
curl -H "Keys: 1" http://localhost/test/test.jpg
```

Получение списка не уникальных имен файлов/ключей в директории (если серверный параметр getkeys = true)

```bash
curl -H "KeysAll: 1" http://localhost/test/test.jpg
```

Скачивание целого Bolt архива из директории (если серверный параметр getbolt = true)

```bash
curl -o test.bolt http://localhost/test/test.bolt
```

Удаление файла/значения (приоритетно удалется обычный файл, если существует, а не значение в bolt архиве)

```bash
curl -X DELETE http://localhost/test/test.jpg
```

Удаление файла/значения из Bolt архива (принудительно)

```bash
curl -X DELETE -H "FromArchive: 1" http://localhost/test/test.jpg
```

Удаление целого Bolt архива из директории (если серверный параметр delbolt = true)

```bash
curl -X DELETE http://localhost/test/test.bolt
```

Миграция данных в 3 шага без остановки сервиса.
------------

Данный сервер был разработан не только с целью использования с нуля, но и на текущих реальных продакшн системах.
Для этого в дополнение с wZD сервером предлагается архиватор <a href=https://github.com/eltaline/wza>wZA</a>.

Архиватор позволяет без удаления, с удалением, сконвертировать текущие файлы в Bolt архивы, и так же распаковать обратно. Поддерживает перезапись и другие функции.

**Архиватор, насколько это возможно, максимально безопасен, не поддерживает рекурсивного обхода, только работу по заранее подготовленному списку файлов или Bolt архивов, обеспечивает повторное считывание файла после упаковки и проверку CRC контрольной суммы на лету.**

Руководство по миграции данных:

Путь который подлежит миграции: /var/storage , здесь лежат jpg файлы 1 миллионе поддиректорий различной глубины, которые надо упаковать в Bolt архивы, но только те которые размером не больше 1 МБ.

- У вас должен уже быть настроен nginx/haproxy и wZD сервер с виртуальным хостом на директорию /var/storage

- Выполнить рекурсивный поиск:
  ```bash
  find /var/storage -type f -name '*.jpg' -not -name '*.bolt' > /tmp/migration.list
  ```
- Запустить архивацию без удаления текущих файлов
  ```bash
  wza --pack --fmaxsize=1048576 --list=/tmp/migration.list
  ```
- Запустить удаление старых файлов с проверкой ключей в Bolt архивах, без удаления файлов, которые размером больше чем fmaxsize.
  ```bash
  wza --pack --delete --fmaxsize=1048576 --list=/tmp/migration.list
  ```

Можно совместить в одну операцию, сразу с удалением старых файлов.
Архиватор пропускает не регулярные файлы и не позволит заархивировать Bolt архив в Bolt архив.
Архиватор не удалит файл пока контрольная сумма считываемого файла не совпадет после архивации с вновь считанным файлом из Bolt архива, если это конечно принудительно не отключить.
Пока работает wZD сервер, он отдает данные из обычных файлов, если находит их. Это приоритетно.

В данном руководстве приведен пример с однопоточным запуском, остановкой при любой ошибке с любым файлом, в том числе если в заранее подготовленный список попали не регулярные файлы или же файлы вдруг были удалены другим процессом, а в списке они остались. Для игнорирования уже несуществующих в реальности файлов из списка требуется добавить параметр --ignore-not. То же верно и при распаковке.

Повторный запуск архивации без параметра --overwrite не перезапишет файлы в Bolt архивах. То же верно и при распаковке.

Архиватор поддерживает и многопоточный вариант --threads= и так же другие опции.
В многопоточном варианте автоматически применяется параметр --ignore, чтобы не останавливать работающие потоки при возникновении любых ошибок. При ошибке и включенном --delete параметре, исходный файл не удалится.

Полное описание всех параметров продукта доступно здесь: <a href="/OPTIONS-RUS.md">Опции</a>

Примечания и Q&A
========

- По своей сути снаружи данный сервер выглядит как обычный WebDAV сервер для пользователя или разработчика.

- Сервер работает только с одним системным пользователем. Все uid/gid для любых создаваемых Bolt архивов и файлов берутся при запуске сервера из под текущего пользователя или из systemd стартового скрипта.

- Сервер автоматически создает директории и Bolt архивы во время загрузки файлов/значений. Просто загрузите файл по нужному пути.

- Bolt архивы именуются автоматически по названию директории в которой они создаются.

- Метод OPTIONS на данный момент не настраивается и не посылает заголовка Access-Control-Allow-Methods. Используйте nginx/haproxy для указания разрешенных методов.

- Эффективное уменьшение количества файлов в рамках инстанса с данными
зависит от выбранной структуры директорий и планируемого
количества загрузки файлов эти директории.

- Не имеет смысла загружать 100000+ файлов в одну директорию, это будет оверхед.
По возможности правильно планируйте структуру директорий.

- Не имеет смысла загружать в Bolt архивы файлы/значения размером больше 32МБ. По умолчанию параметр fmaxsize = 1048576 байт. 

- При превышении параметра fmaxsize, даже при установленном клиентском заголовке "Archive: 1" данные загрузятся
в отдельный обычный файл без уведомления.

- Максимально возможный размер параметра fmaxsize = 536870912 байт.

- Если вы включили параметр nonunique = true в виртуальном хосте, это значит что wZD сервер позволит загружать отдельные файлы
с тем же именем, даже если в Bolt архиве в этой директории уже есть данные с тем же именем ключа,
что и в загружаемом файле мимо Bolt архива.

- Несмотря на то, что параметр nonunique = false выключен в виртуальном хосте, wZD сервер загрузит файл/значение в новый Bolt архив, даже если имя ключа совпадает с уже существующим именем файла в этой директории. Это требуется для безостановочной работы сервиса и работы в смешанном режиме во время миграции данных в Bolt архивы, в том числе при безостановочном добавлении новых файлов через PUT метод или их удалении через DELETE метод.

- При использовании параметров writeintegrity=true и readintegrity=true загружаемый или скачиваемый файл/значение полностью записывается в оперативную память. Но не более 512 МБ на 1 запрос, при максимально выставленном параметре fmaxsize.
Настоятельно рекомендуется включить данные параметры в true. Данные параметры влияют только на файлы/значения в Bolt архивах.

- Если вы забыли включить параметр writeintegrity=true и загрузили много файлов/значений в Bolt архивы, то в таком случае для них не была подсчитана контрольная сумма, но теперь вы хотите все-таки, чтобы контрольная сумма была подсчитана и записана, тогда можно воспользоваться <a href=https://github.com/eltaline/wza>wZA</a> архиватором, чтобы распаковать все текущие Bolt архивы и перепаковать их снова, но уже не отключая в самом архиваторе запись CRC суммы. В дальнейшем в архиваторе будет сделана поддержка подсчета и записи контрольной суммы для файлов/значений в текущих Bolt архивах без операций распаковки и упаковки, в том случае если контрольной суммы у значений в Bolt архивах не было изначально.

- Если контрольная сумма у файлов/значений не была подсчитана и записана в следствие установленного параметра writeintegrity=false, то при включенном параметре readintegrity=true все будет работать, но при скачивании контрольная сумма проверяться конечно не будет.

- Cервер не позволяет загружать файлы в корневую директорию виртуального хоста. Это запрещено только при попытке загрузить файл/значение в корень виртуального хоста при установленном заголовке "Archive: 1". Обычные файлы без упаковки можно загружать в корень виртуального хоста.

- Сервер использует расширенную версию BoltDB, текущим разработчиком wZD. Добавлены функции GetLimit(), GetOffset(), GetRange().
Это позволяет считывать по байтово из файлов/значений столько данных сколько нужно, например при использовании заголовков "Range: bytes=..." , If-None-Match, If-Modified-Since или методов HEAD и OPTIONS, что позволяет так же значительно экономить ресурсы дисковой подсистемы, чем просто так считывался бы весь файл/значение при использовании штатной функции Get().

- Сервер не создает никаких временных файлов во время своей работы, и при этом потребляет мало оперативной памяти. Передача больших файлов осуществляется через настраиваемые полу-динамические буферы малого размера на лету. В wZD не используются простые функции ctx.SendFile() и ctx.ServeContent().

- Некоторые параметры по желанию сообщества могут быть перенесены из секции [global] в секцию [server].
- По желанию сообщества, так же может быть добавлен новый расширенный функционал. Пользуйтесь feature request.

ТуДу
========

- Разрабокта собственного репликатора/дистрибьютора + гео для возможности использования в больших системах без кластерных ФС.
- Возможность полного реверсивного восстановления метаданных при их полной утере(в случае использования репликатора/дистрибьютора)
- Нативный протокол для возможности использования постоянных сетевых соединений и драйверы к разным языкам программирования.
- Расширенные возможности использования NoSQL составляющей.
- Отказ от sqlite/mysql/pgsql в пользу более простого решения (отказ от CGO).
- Компрессии разных типов (gzip, zstd, snappy) для файлов/значений внутри Bolt архивов и для обычных файлов.
- Шифрование разных типов для файлов/значений внутри Bolt архивов и для обычных файлов.
- Отложенная серверная видео конвертация в том числе и на GPU.

Параметры:
========

Полное описание всех параметров продукта доступно здесь: <a href="/OPTIONS-RUS.md">Опции</a>

Гарантии:
========

Никакие гарантии на данное программное обеспечение не предоставляются. Просьба сначала тестировать.

Контакты:
========

- E-Mail: dev@wzd.dev
- Cайт wZD: https://wzd.dev
- Сайт компании: <a href="https://elta.ee">Eltaline</a>

```
Copyright (C) 2020 Andrey Kuvshinov
Copyright (C) 2020 Eltaline OU
All rights reserved.
```
